<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Important Messages</title>
    <!-- Assuming Bootstrap 5 for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f7f9fc; }
        .container { max-width: 900px; }
        .message-item {
            background: #fff;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            border-left: 5px solid; /* Defined by JS class */
        }
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .unread-mark { border-left-color: #007bff !important; }
        .read-mark { border-left-color: #ccc !important; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4 text-primary"><i class="bi bi-bell-fill me-2"></i> Important Messages</h2>
        <div id="messagesList">
            <!-- Messages will be injected here -->
            <div class="alert alert-info text-center" role="alert">
                <i class="bi bi-arrow-clockwise"></i> Loading messages...
            </div>
        </div>
    </div>

    <script>
        // NOTE: Replace 'http://localhost:3000' with your actual backend URL
        const API_BASE = 'http://localhost:3000'; 

        document.addEventListener("DOMContentLoaded", async () => {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("user_id");
            const messagesList = document.getElementById("messagesList");

            if (!token || !userId) {
                messagesList.innerHTML = '<div class="alert alert-warning">Please login first! Redirecting...</div>';
                setTimeout(() => { window.location.href = "login.html"; }, 1500);
                return;
            }

            try {
                // Fetch messages for the user
                const res = await fetch(`${API_BASE}/api/messages/user/${userId}`, {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                // Assuming the backend populates the senderId (practitioner/admin name)
                const messages = await res.json(); 

                if (Array.isArray(messages) && messages.length > 0) {
                    messagesList.innerHTML = messages.map(m => {
                        // Safely access the sender name from the populated object
                        const senderName = m.senderId?.name || 'System Administrator';
                        const date = m.dateSent ? new Date(m.dateSent).toLocaleDateString() : 'N/A';
                        const statusClass = m.isRead ? 'read-mark' : 'unread-mark';

                        return `
                            <div class="message-item ${statusClass}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="fw-bold mb-0 text-dark">${m.subject || 'No Subject'}</h5>
                                    ${!m.isRead ? '<span class="badge bg-danger">NEW</span>' : ''}
                                </div>
                                <p class="text-muted mb-1 mt-1">From: <span class="fw-semibold">${senderName}</span> | Sent: ${date}</p>
                                <p class="mt-2 mb-2 text-dark">${m.content || '... Message content missing ...'}</p>
                                <button onclick="markAsRead('${m._id}')" class="btn btn-sm ${m.isRead ? 'btn-outline-secondary' : 'btn-primary'}">
                                    ${m.isRead ? 'Read' : 'Mark as Read'}
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    messagesList.innerHTML = '<div class="alert alert-success text-center fw-bold"><i class="bi bi-check-circle me-2"></i> No important messages found.</div>';
                }

            } catch (err) {
                console.error("Messages load error:", err);
                messagesList.innerHTML = `<div class="alert alert-danger">Error loading messages: ${err.message}. Ensure backend is running and the API route is correctly defined.</div>`;
            }
        });

        // Mock function for marking a message as read (Requires a backend PUT route: /api/messages/:id/read)
        async function markAsRead(messageId) {
            console.log("Mock action: Marking message as read:", messageId);
            // In a real app, you would send a PUT request here:
            // await fetch(`${API_BASE}/api/messages/${messageId}/read`, { method: 'PUT', headers: { ... } });
            // Then reload or update the UI
            location.reload(); 
        }
    </script>
</body>
</html>